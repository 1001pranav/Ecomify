// This is your Prisma schema file for Ecomify Platform
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Authentication & Authorization
// ============================================================================

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String
  firstName         String
  lastName          String
  isVerified        Boolean  @default(false)
  verificationToken String?
  mfaEnabled        Boolean  @default(false)
  mfaSecret         String?  // Encrypted
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  roles    UserRole[]
  sessions Session[]
  stores   Store[]    @relation("StoreOwner")

  @@index([email])
  @@map("users")
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  role   Role

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([userId])
  @@map("user_roles")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

enum Role {
  PLATFORM_ADMIN
  MERCHANT
  STORE_STAFF
  CUSTOMER
}

// ============================================================================
// Store Management
// ============================================================================

model Store {
  id           String      @id @default(cuid())
  ownerId      String
  name         String
  slug         String      @unique
  domain       String?     @unique
  customDomain String?     @unique
  email        String
  phone        String?
  currency     String      @default("USD")
  locale       String      @default("en-US")
  timezone     String      @default("UTC")
  settings     Json        @default("{}")
  theme        Json        @default("{}")
  status       StoreStatus @default(ACTIVE)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  owner      User       @relation("StoreOwner", fields: [ownerId], references: [id])
  products   Product[]
  orders     Order[]
  categories Category[]
  customers  Customer[]

  @@index([ownerId])
  @@index([slug])
  @@index([status])
  @@map("stores")
}

enum StoreStatus {
  ACTIVE
  PAUSED
  SUSPENDED
  CLOSED
}

// ============================================================================
// Product Catalog
// ============================================================================

model Product {
  id             String        @id @default(cuid())
  storeId        String
  title          String
  description    String?       @db.Text
  handle         String
  vendor         String?
  productType    String?
  tags           String[]
  status         ProductStatus @default(DRAFT)
  publishedAt    DateTime?
  seoTitle       String?
  seoDescription String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  store      Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  variants   ProductVariant[]
  images     ProductImage[]
  options    ProductOption[]
  categories Category[]
  collections ProductCollection[]

  @@unique([storeId, handle])
  @@index([storeId, status])
  @@map("products")
}

model ProductVariant {
  id             String   @id @default(cuid())
  productId      String
  sku            String?  @unique
  barcode        String?
  title          String
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  costPrice      Decimal? @db.Decimal(10, 2)
  inventoryQty   Int      @default(0)
  trackInventory Boolean  @default(true)
  weight         Decimal? @db.Decimal(10, 2)
  weightUnit     String?  @default("kg")
  options        Json     // {color: "Red", size: "L"}
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  lineItems OrderLineItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductOption {
  id        String   @id @default(cuid())
  productId String
  name      String
  position  Int
  values    String[]

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_options")
}

model ProductImage {
  id        String @id @default(cuid())
  productId String
  url       String
  altText   String?
  position  Int

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model Category {
  id          String     @id @default(cuid())
  storeId     String
  name        String
  slug        String
  description String?
  parentId    String?
  position    Int        @default(0)

  store    Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([parentId])
  @@map("categories")
}

model Collection {
  id          String         @id @default(cuid())
  storeId     String
  title       String
  description String?
  type        CollectionType
  conditions  Json?          // For automated collections

  products ProductCollection[]

  @@index([storeId])
  @@map("collections")
}

model ProductCollection {
  productId    String
  collectionId String
  position     Int     @default(0)

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([productId, collectionId])
  @@map("product_collections")
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CollectionType {
  MANUAL
  AUTOMATED
}

// ============================================================================
// Order Management
// ============================================================================

model Order {
  id                String            @id @default(cuid())
  orderNumber       String            @unique
  storeId           String
  customerId        String?
  subtotalPrice     Decimal           @db.Decimal(10, 2)
  totalTax          Decimal           @db.Decimal(10, 2)
  totalShipping     Decimal           @db.Decimal(10, 2)
  totalDiscount     Decimal           @db.Decimal(10, 2)
  totalPrice        Decimal           @db.Decimal(10, 2)
  currency          String
  financialStatus   FinancialStatus
  fulfillmentStatus FulfillmentStatus
  email             String
  phone             String?
  shippingAddress   Json
  billingAddress    Json
  note              String?
  tags              String[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  store     Store           @relation(fields: [storeId], references: [id])
  customer  Customer?       @relation(fields: [customerId], references: [id])
  lineItems OrderLineItem[]

  @@index([storeId])
  @@index([customerId])
  @@index([orderNumber])
  @@index([financialStatus])
  @@index([fulfillmentStatus])
  @@map("orders")
}

model OrderLineItem {
  id           String  @id @default(cuid())
  orderId      String
  variantId    String
  title        String
  variantTitle String?
  sku          String?
  quantity     Int
  price        Decimal @db.Decimal(10, 2)
  totalPrice   Decimal @db.Decimal(10, 2)

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@map("order_line_items")
}

enum FinancialStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  VOIDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
}

// ============================================================================
// Customer Management
// ============================================================================

model Customer {
  id               String   @id @default(cuid())
  storeId          String
  userId           String?  @unique
  firstName        String
  lastName         String
  email            String
  phone            String?
  totalSpent       Decimal  @db.Decimal(10, 2) @default(0)
  ordersCount      Int      @default(0)
  tags             String[]
  note             String?
  acceptsMarketing Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  store            Store                       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  addresses        Address[]
  orders           Order[]
  segmentMemberships CustomerSegmentMembership[]

  @@unique([storeId, email])
  @@index([storeId])
  @@index([email])
  @@map("customers")
}

model Address {
  id         String  @id @default(cuid())
  customerId String
  firstName  String
  lastName   String
  company    String?
  address1   String
  address2   String?
  city       String
  province   String?
  country    String
  zip        String
  phone      String?
  isDefault  Boolean @default(false)

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@map("addresses")
}

// ============================================================================
// Analytics
// ============================================================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  storeId   String
  eventType String
  eventData Json
  timestamp DateTime @default(now())

  @@index([storeId, eventType, timestamp])
  @@map("analytics_events")
}

model DailySalesMetrics {
  id       String   @id @default(cuid())
  storeId  String
  date     DateTime
  revenue  Decimal  @db.Decimal(10, 2)
  orders   Int
  units    Int
  avgOrder Decimal  @db.Decimal(10, 2)

  @@unique([storeId, date])
  @@index([storeId, date])
  @@map("daily_sales_metrics")
}

model ProductPerformanceMetrics {
  id         String   @id @default(cuid())
  storeId    String
  productId  String
  date       DateTime
  revenue    Decimal  @db.Decimal(10, 2)
  unitsSold  Int
  views      Int      @default(0)
  addToCarts Int      @default(0)

  @@unique([storeId, productId, date])
  @@index([storeId, productId, date])
  @@map("product_performance_metrics")
}

// ============================================================================
// Customer Segmentation
// ============================================================================

model CustomerSegment {
  id         String   @id @default(cuid())
  storeId    String
  name       String
  conditions Json // Segment rules
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  memberships CustomerSegmentMembership[]

  @@index([storeId])
  @@map("customer_segments")
}

model CustomerSegmentMembership {
  customerId String
  segmentId  String
  addedAt    DateTime @default(now())

  customer Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  segment  CustomerSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@id([customerId, segmentId])
  @@index([customerId])
  @@index([segmentId])
  @@map("customer_segment_memberships")
}

// ============================================================================
// System & Configuration
// ============================================================================

model MigrationHistory {
  id          String   @id @default(cuid())
  name        String   @unique
  executedAt  DateTime @default(now())
  description String?

  @@map("migration_history")
}
