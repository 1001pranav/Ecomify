// Product Service Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Product Model - Core product entity
model Product {
  id              String        @id @default(cuid())
  storeId         String

  title           String
  description     String?       @db.Text
  handle          String
  vendor          String?
  productType     String?
  tags            String[]

  status          ProductStatus @default(DRAFT)
  publishedAt     DateTime?

  // SEO
  seoTitle        String?
  seoDescription  String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  variants        ProductVariant[]
  images          ProductImage[]
  options         ProductOption[]
  categories      ProductCategory[]
  collections     ProductCollection[]

  @@unique([storeId, handle])
  @@index([storeId, status])
  @@index([storeId])
  @@index([handle])
}

// Product Variant - SKU level product
model ProductVariant {
  id                    String   @id @default(cuid())
  productId             String

  sku                   String?  @unique
  barcode               String?
  title                 String

  price                 Decimal  @db.Decimal(10, 2)
  compareAtPrice        Decimal? @db.Decimal(10, 2)
  costPrice             Decimal? @db.Decimal(10, 2)

  inventoryQty          Int      @default(0)
  trackInventory        Boolean  @default(true)

  weight                Decimal? @db.Decimal(10, 2)
  weightUnit            String?  @default("kg")

  options               Json     // {color: "Red", size: "L"}

  imageUrl              String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  product               Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
}

// Product Option - Configurable options (Color, Size, etc.)
model ProductOption {
  id          String   @id @default(cuid())
  productId   String
  name        String
  position    Int
  values      String[]

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// Product Image - Product media
model ProductImage {
  id          String   @id @default(cuid())
  productId   String
  url         String
  altText     String?
  position    Int

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// Category - Hierarchical product categorization
model Category {
  id          String     @id @default(cuid())
  storeId     String
  name        String
  slug        String
  description String?
  parentId    String?
  position    Int        @default(0)

  imageUrl    String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    ProductCategory[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([parentId])
}

// ProductCategory - Many-to-many relation
model ProductCategory {
  productId    String
  categoryId   String
  position     Int     @default(0)

  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  category     Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}

// Collection - Curated product groups
model Collection {
  id          String           @id @default(cuid())
  storeId     String
  title       String
  handle      String
  description String?
  type        CollectionType
  conditions  Json?            // For automated collections

  imageUrl    String?
  published   Boolean          @default(false)

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  products    ProductCollection[]

  @@unique([storeId, handle])
  @@index([storeId])
  @@index([type])
}

// ProductCollection - Many-to-many relation
model ProductCollection {
  productId    String
  collectionId String
  position     Int     @default(0)

  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([productId, collectionId])
  @@index([productId])
  @@index([collectionId])
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CollectionType {
  MANUAL
  AUTOMATED
}
